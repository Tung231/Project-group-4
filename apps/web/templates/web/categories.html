{% extends 'web/base.html' %} 
{% block content %}
<style>
    .page-header {
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(255, 107, 157, 0.3);
    }

    .page-header h2 {
        margin: 0;
        font-weight: 600;
        font-size: 2rem;
    }

    .btn-add-category {
        background: white;
        color: #ff6b9d;
        border: 2px solid white;
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 50px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-add-category:hover {
        background: transparent;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .table-card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(255, 107, 157, 0.2);
        overflow: hidden;
        background: #ffe4e9;
    }

    .table thead {
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        color: white;
    }

    .table tbody tr {
        transition: all 0.3s ease;
    }

    .table tbody tr:hover {
        background: #ffb3c6;
        transform: scale(1.01);
    }

    .badge.bg-success {
        background: linear-gradient(135deg, #ff9ec5 0%, #ff6b9d 100%) !important;
    }

    .badge.bg-danger {
        background: linear-gradient(135deg, #ff8fab 0%, #ffb3c6 100%) !important;
    }

    .btn-outline-danger {
        border-color: #ff6b9d;
        color: #ff6b9d;
        transition: all 0.3s ease;
    }

    .btn-outline-danger:hover {
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        border-color: #ff6b9d;
        color: white;
        transform: translateY(-2px);
    }

    .modal-content {
        border: none;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        color: white;
        border-radius: 20px 20px 0 0;
        padding: 1.5rem;
        border: none;
    }

    .modal-title {
        font-weight: 600;
        font-size: 1.5rem;
    }

    .btn-close {
        filter: brightness(0) invert(1);
    }

    .modal-body {
        padding: 2rem;
    }

    .form-label {
        font-weight: 600;
        color: #ff6b9d;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #ff6b9d;
        box-shadow: 0 0 0 0.2rem rgba(255, 107, 157, 0.25);
    }

    .btn-submit {
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        border: none;
        padding: 0.75rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-top: 1rem;
        color: white;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(255, 107, 157, 0.4);
        color: white;
    }
</style>
<div class="page-header d-flex justify-content-between align-items-center">
    <h2>üè∑Ô∏è Qu·∫£n l√Ω Danh m·ª•c</h2>
    <button class="btn btn-add-category" data-bs-toggle="modal" data-bs-target="#addCatModal">+ Th√™m Danh m·ª•c</button>
</div>

<div class="table-card">
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th>T√™n</th>
                <th>Lo·∫°i</th>
                <th>Thu·ªôc nh√≥m (Cha)</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody id="cat-list"></tbody>
    </table>
</div>

<div class="modal fade" id="addCatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th√™m Danh m·ª•c</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="add-cat-form">
                    <div class="mb-3">
                        <label class="form-label">T√™n Danh m·ª•c</label>
                        <input type="text" class="form-control" id="cat-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i</label>
                        <select class="form-select" id="cat-type">
                            <option value="expense">Chi ti√™u</option>
                            <option value="income">Thu nh·∫≠p</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh m·ª•c Cha (N·∫øu c√≥)</label>
                        <select class="form-select" id="cat-parent">
                            <option value="">-- Kh√¥ng --</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-submit w-100">L∆∞u</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
    let categories = [];

    async function loadCategories() {
        const res = await fetch('/api/finance/categories/', {
            headers: {
                'Authorization': `Token ${localStorage.getItem('token')}` // <--- S·ª≠a d√≤ng n√†y
            }
        });
        const data = await res.json();
        categories = data.results;

        const tbody = document.getElementById('cat-list');
        const parentSelect = document.getElementById('cat-parent');
        tbody.innerHTML = '';
        parentSelect.innerHTML = '<option value="">-- Kh√¥ng --</option>';

        categories.forEach(cat => {
            // Fill Table
            // C√°ch vi·∫øt an to√†n h∆°n (thay th·∫ø d√≤ng 63 c≈©)
            let parentName = '-';
            if (cat.parent) {
                const parentObj = categories.find(c => c.id === cat.parent);
                if (parentObj) parentName = parentObj.name;
            }
            const typeBadge = cat.type === 'income' ? 'bg-success' : 'bg-danger';
            tbody.innerHTML += `
                <tr>
                    <td>${cat.name}</td>
                    <td><span class="badge ${typeBadge}">${cat.type}</span></td>
                    <td>${parentName}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deleteCat(${cat.id})">X√≥a</button></td>
                </tr>
            `;
            // Fill Dropdown (ch·ªâ l·∫•y danh m·ª•c ch∆∞a c√≥ cha ƒë·ªÉ l√†m cha)
            if (!cat.parent) {
                parentSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            }
        });
    }

    document.getElementById('add-cat-form').addEventListener('submit', async(e) => {
        e.preventDefault();
        const payload = {
            name: document.getElementById('cat-name').value,
            type: document.getElementById('cat-type').value,
            parent: document.getElementById('cat-parent').value || null
        };
        const res = await fetch('/api/finance/categories/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Token ${token}`
            },
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            location.reload();
        } else {
            alert('L·ªói th√™m danh m·ª•c');
        }
    });

    async function deleteCat(id) {
        if (!confirm('X√≥a danh m·ª•c n√†y?')) return;
        await fetch(`/api/finance/categories/${id}/`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Token ${token}`
            }
        });
        loadCategories();
    }
    loadCategories();
</script>
{% endblock %}