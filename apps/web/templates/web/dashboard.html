{% extends 'web/base.html' %} {% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2" style="color: #ff6b9d; font-weight: 700;">üìä Dashboard</h1>
    <button class="btn btn-primary" style="border-radius: 50px;" data-bs-toggle="modal" data-bs-target="#addTxModal">
        + New Transaction
    </button>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3 h-100" style="background: linear-gradient(135deg, #20bf6b 0%, #0fb9b1 100%) !important; border: none;">
            <div class="card-body text-center">
                <h5 class="card-title">Total Income</h5>
                <h2 class="display-6 fw-bold" id="kpi-income">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger mb-3 h-100" style="background: linear-gradient(135deg, #eb3b5a 0%, #fc5c65 100%) !important; border: none;">
            <div class="card-body text-center">
                <h5 class="card-title">Total Expense</h5>
                <h2 class="display-6 fw-bold" id="kpi-expense">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3 h-100" style="background: linear-gradient(135deg, #4b7bec 0%, #3867d6 100%) !important; border: none;">
            <div class="card-body text-center">
                <h5 class="card-title">Net Balance</h5>
                <h2 class="display-6 fw-bold" id="kpi-net">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span class="fw-bold" style="color: #ff6b9d;">Spending Trend</span>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="chartmode" id="modeDay" value="day" checked onchange="loadCharts('day')">
                    <label class="btn btn-outline-primary" for="modeDay">30 Days</label>

                    <input type="radio" class="btn-check" name="chartmode" id="modeMonth" value="month" onchange="loadCharts('month')">
                    <label class="btn btn-outline-primary" for="modeMonth">12 Months</label>

                    <input type="radio" class="btn-check" name="chartmode" id="modeYear" value="year" onchange="loadCharts('year')">
                    <label class="btn btn-outline-primary" for="modeYear">5 Years</label>
                </div>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white fw-bold" style="color: #ff6b9d;">Structure</div>
            <div class="card-body">
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="catChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold" style="color: #ff6b9d;">Recent Transactions</h5>

        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="filter-type" onchange="loadTransactions()">
                <option value="">All Types</option>
                <option value="expense">üî¥ Expense</option>
                <option value="income">üü¢ Income</option>
            </select>
            <select class="form-select form-select-sm" id="sort-by" onchange="loadTransactions()">
                <option value="-occurred_at">Newest First</option>
                <option value="occurred_at">Oldest First</option>
                <option value="-amount">Highest Amount</option>
            </select>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Account</th>
                    <th>Amount</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody id="tx-table-body"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addTxModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Transaction</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="add-tx-form">
                    <div class="mb-3"><label>Type</label><select class="form-select" id="tx-type"><option value="expense">Expense</option><option value="income">Income</option></select></div>
                    <div class="mb-3"><label>Amount</label><input type="number" class="form-control" id="tx-amount" required></div>
                    <div class="row">
                        <div class="col-6 mb-3"><label>Category</label><select class="form-select" id="tx-category"></select></div>
                        <div class="col-6 mb-3"><label>Account</label><select class="form-select" id="tx-account"></select></div>
                    </div>
                    <div class="mb-3"><label>Note</label><input type="text" class="form-control" id="tx-note"></div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    // --- 1. CHART LOGIC ---
    let dailyChartInstance = null;
    let catChartInstance = null;

    async function loadCharts(mode = 'day') {
        const res = await fetch(`/api/finance/transactions/charts/?mode=${mode}`, {
            headers: {
                'Authorization': `Token ${localStorage.getItem('token')}`
            }
        });
        const data = await res.json();

        // Render Chart C·ªôt (Timeline)
        const ctxDaily = document.getElementById('dailyChart');
        if (dailyChartInstance) dailyChartInstance.destroy();

        // Format ng√†y th√°ng hi·ªÉn th·ªã ƒë·∫πp h∆°n
        const labels = data.timeline.map(d => {
            const date = new Date(d.date);
            if (mode === 'year') return date.getFullYear();
            if (mode === 'month') return `${date.getMonth()+1}/${date.getFullYear()}`;
            return `${date.getDate()}/${date.getMonth()+1}`;
        });

        dailyChartInstance = new Chart(ctxDaily, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Expense',
                    data: data.timeline.map(d => d.total),
                    backgroundColor: '#ff6b9d',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Render Chart Tr√≤n (Category)
        const ctxCat = document.getElementById('catChart');
        if (catChartInstance) catChartInstance.destroy();
        catChartInstance = new Chart(ctxCat, {
            type: 'doughnut',
            data: {
                labels: data.category.map(c => c.category__name || 'Uncategorized'),
                datasets: [{
                    data: data.category.map(c => c.total),
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // --- 2. TRANSACTION LIST LOGIC (C√ì SORT & FILTER) ---
    async function loadTransactions() {
        const typeFilter = document.getElementById('filter-type').value;
        const sortBy = document.getElementById('sort-by').value;

        let url = `/api/finance/transactions/?sort=${sortBy}`;
        if (typeFilter) url += `&type=${typeFilter}`;

        const res = await fetch(url, {
            headers: {
                'Authorization': `Token ${localStorage.getItem('token')}`
            }
        });
        const data = await res.json();

        const tbody = document.getElementById('tx-table-body');
        tbody.innerHTML = '';
        if (data.results) {
            data.results.forEach(tx => {
                const typeBadge = tx.type === 'income' ? 'bg-success' : 'bg-danger';
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(tx.occurred_at).toLocaleDateString()}</td>
                        <td><span class="badge ${typeBadge}">${tx.type}</span></td>
                        <td>${tx.category_name || '-'}</td>
                        <td>${tx.account_name}</td>
                        <td class="fw-bold">${Number(tx.amount).toLocaleString()}</td>
                        <td>${tx.notes || ''}</td>
                    </tr>`;
            });
        }
    }

    // --- 3. C√ÅC H√ÄM C≈® (KPI & DROPDOWN) ---
    async function loadKPI() {
        const res = await fetch('/api/finance/transactions/kpi/', {
            headers: {
                'Authorization': `Token ${localStorage.getItem('token')}`
            }
        });
        const kpiData = await res.json();
        document.getElementById('kpi-income').innerText = Number(kpiData.income).toLocaleString();
        document.getElementById('kpi-expense').innerText = Number(kpiData.expense).toLocaleString();
        document.getElementById('kpi-net').innerText = Number(kpiData.net).toLocaleString();
    }

    async function loadDropdowns() { /* (Gi·ªØ nguy√™n code c≈© c·ªßa b·∫°n ·ªü ƒë√¢y) */
        const headers = {
            'Authorization': `Token ${localStorage.getItem('token')}`
        };
        const catRes = await fetch('/api/finance/categories/', {
            headers
        });
        const catData = await catRes.json();
        const catSelect = document.getElementById('tx-category');
        catSelect.innerHTML = '<option value="">-- Select --</option>';
        catData.results.forEach(c => catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

        const accRes = await fetch('/api/finance/accounts/', {
            headers
        });
        const accData = await accRes.json();
        const accSelect = document.getElementById('tx-account');
        accSelect.innerHTML = '<option value="">-- Select --</option>';
        accData.results.forEach(a => accSelect.innerHTML += `<option value="${a.id}">${a.name}</option>`);
    }

    document.getElementById('add-tx-form').addEventListener('submit', async(e) => { /* (Gi·ªØ nguy√™n code c≈© c·ªßa b·∫°n) */
        e.preventDefault();
        const payload = {
            type: document.getElementById('tx-type').value,
            amount: document.getElementById('tx-amount').value,
            category: document.getElementById('tx-category').value || null,
            account: document.getElementById('tx-account').value,
            notes: document.getElementById('tx-note').value,
            occurred_at: new Date().toISOString()
        };
        const res = await fetch('/api/finance/transactions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Token ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addTxModal')).hide();
            document.getElementById('add-tx-form').reset();
            loadTransactions();
            loadKPI();
            loadCharts(); // Reload all
        } else {
            alert('Error adding transaction');
        }
    });

    // INIT
    loadKPI();
    loadCharts('day'); // Load m·∫∑c ƒë·ªãnh 30 ng√†y
    loadTransactions();
    loadDropdowns();
</script>
{% endblock %}